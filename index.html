<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Metronome SPA</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
  body{font-family:Arial,Helvetica,sans-serif;background:#f4f4f4;margin:0;padding:0;display:flex;justify-content:center;align-items:center;height:100vh;}
  .container{background:#fff;border-radius:8px;box-shadow:0 2px 10px rgba(0,0,0,.1);padding:24px;width:320px;text-align:center;}
  h1{font-size:1.6rem;margin:0 0 12px;}
  .bpm-control{display:flex;align-items:center;justify-content:center;margin:12px 0;}
  .bpm-control input[type=number]{width:60px;margin-left:8px;text-align:center;}
  .bpm-control input[type=range]{width:200px;}
  .beat{font-size:4rem;color:#444;margin:12px 0;}
  button{background:#28a745;color:#fff;border:none;padding:10px 20px;border-radius:4px;font-size:1rem;cursor:pointer;}
  button.stop{background:#dc3545;}
  button:focus{outline:none;}
</style>
</head>
<body>

<div class="container">
  <h1>Metronome</h1>
  <div class="bpm-control">
    <label for="bpm">BPM:</label>
    <input type="range" id="bpm" min="40" max="240" value="120">
    <input type="number" id="bpmNum" min="40" max="240" value="120">
  </div>
  <div class="beat" id="beatDisplay">1</div>
  <button id="toggleBtn">Start</button>
</div>

<script>
/* ───── 1️⃣  Web Audio – short click oscillator ──────── */
const AudioContext = window.AudioContext || window.webkitAudioContext;
const ctx = new AudioContext();

let currentOsc = null;          // keep a ref so we can stop it if needed

function playClick() {
  const osc = ctx.createOscillator();
  const gain = ctx.createGain();

  osc.type = 'square';
  osc.frequency.setValueAtTime(1000, ctx.currentTime); // 1 kHz
  gain.gain.setValueAtTime(0.3, ctx.currentTime);
  gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 0.05);

  osc.connect(gain);
  gain.connect(ctx.destination);
  osc.start(ctx.currentTime);
  osc.stop(ctx.currentTime + 0.05);

  currentOsc = osc;               // save reference for quick stop
}

/* ───── 2️⃣  UI & state ────────────────────────────────── */
let isRunning = false;
let bpm = 120;
let beat = 0;
let intervalId = null;            // id returned by setInterval

const bpmSlider = document.getElementById('bpm');
const bpmInput  = document.getElementById('bpmNum');
const beatDisp  = document.getElementById('beatDisplay');
const toggleBtn = document.getElementById('toggleBtn');

bpmSlider.addEventListener('input', e => {
  bpm = +e.target.value;
  bpmInput.value = bpm;
});
bpmInput.addEventListener('input', e => {
  let val = +e.target.value;
  if (val < 40) val = 40;
  if (val > 240) val = 240;
  bpm = val;
  bpmSlider.value = val;
});

/* ───── 3️⃣  Start / Stop logic ─────────────────────────── */
function startMetronome() {
  // Make sure the AudioContext is resumed (iOS/Android)
  if (ctx.state === 'suspended') ctx.resume();

  isRunning = true;
  beat = 0;
  beatDisp.textContent = '1';
  toggleBtn.textContent = 'Stop';
  toggleBtn.classList.add('stop');

  // Schedule the first tick immediately
  playClick();

  // Every 60 s / bpm seconds we click
  intervalId = setInterval(() => {
    beat = (beat + 1) % 4;
    beatDisp.textContent = (beat + 1).toString();
    playClick();
  }, 60000 / bpm);
}

function stopMetronome() {
  isRunning = false;
  if (intervalId) clearInterval(intervalId);
  intervalId = null;
  toggleBtn.textContent = 'Start';
  toggleBtn.classList.remove('stop');

  // Optionally stop the oscillator that might still be playing
  if (currentOsc) {
    currentOsc.stop();
    currentOsc = null;
  }
}

/* ───── 4️⃣  Button handler ─────────────────────────────── */
toggleBtn.addEventListener('click', () => {
  if (!isRunning) startMetronome();
  else stopMetronome();
});

/* ───── 5️⃣  Touch‑friendly – resume AudioContext ─────────── */
document.body.addEventListener('touchstart', () => {
  if (ctx.state === 'suspended') ctx.resume();
});
</script>
</body>
</html>
